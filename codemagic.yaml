# codemagic.yaml - Flutter iOS Unsigned Build
workflows:
  ios_unsigned_build:
    name: iOS Unsigned IPA
    description: "Build unsigned IPA for manual signing"
    environment:
      # الإصدارات الموصى بها (تعديلها حسب مشروعك)
      flutter: "3.19.5"  
      xcode: "15.2"
      cocoapods: "1.15.2"

    # تعطيل التوقيع التلقائي
    ios_signing:
      distribution_type: none

    scripts:
      # الخطوة 1: التحقق من البيئة
      - name: Verify Environment
        script: |
          flutter doctor -v
          which pod
          pod --version

      # الخطوة 2: تنظيف وإعداد المشروع
      - name: Clean & Setup
        script: |
          flutter clean
          flutter pub get
          rm -rf ios/Pods ios/Podfile.lock

      # الخطوة 3: إعداد iOS
      - name: iOS Preparation
        script: |
          cd ios
          pod repo update
          pod install --verbose
          cd ..
          # إصلاح أذونات الملفات
          chmod -R 755 ios/

      # الخطوة 4: البناء مع سجلات مفصلة
      - name: Build IPA (Unsigned)
        script: |
          flutter build ipa \
            --release \
            --no-codesign \
            --dart-define=CODESIGNING_DISABLED=true \
            --verbose

      # الخطوة 5: التحقق من الملف الناتج
      - name: Verify Artifacts
        script: |
          if ls build/ios/ipa/*.ipa 1> /dev/null 2>&1; then
            echo "✅ IPA generated successfully"
            ls -lh build/ios/ipa/
          else
            echo "❌ IPA file not found!"
            exit 1
          fi

    artifacts:
      - build/ios/ipa/*.ipa
      - ios/Runner.xcarchive/**/*  # مهم للتوقيع لاحقاً
      - ios/Flutter/flutter_export_environment.sh

    publishing:
      scripts:
        - name: Prepare for Manual Signing
          script: |
            echo "Download these files for manual signing:"
            echo "1. .ipa file"
            echo "2. .xcarchive folder"
            echo "3. ExportOptions.plist (create if missing)"
