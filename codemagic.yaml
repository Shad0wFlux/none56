workflows:
  ios_unsigned_build:
    name: iOS Unsigned IPA
    environment:
      flutter: "3.19.5"
      xcode: "15.2"
      cocoapods: "1.15.2"

    scripts:
      # الخطوة 1: التحقق من البيئة
      - name: Verify Environment
        script: |
          flutter doctor -v
          which pod
          pod --version

      # الخطوة 2: تنظيف وإعداد المشروع
      - name: Clean & Setup
        script: |
          flutter clean
          flutter pub get
          rm -rf ios/Pods ios/Podfile.lock

      # الخطوة 3: إعداد iOS
      - name: iOS Preparation
        script: |
          cd ios
          pod repo update
          pod install --verbose
          cd ..
          chmod -R 755 ios/

      # الخطوة 4: البناء بدون توقيع
      - name: Build Unsigned IPA
        script: |
          flutter build ipa \
            --release \
            --no-codesign \
            --dart-define=CODESIGNING_DISABLED=true \
            --verbose

      # الخطوة 5: التحقق من الملف الناتج
      - name: Verify Artifacts
        script: |
          if ls build/ios/ipa/*.ipa 1> /dev/null 2>&1; then
            echo "✅ IPA generated successfully"
            ls -lh build/ios/ipa/
          else
            echo "❌ IPA file not found!"
            exit 1
          fi

    artifacts:
      - build/ios/ipa/*.ipa
      - ios/Runner.xcarchive/**/*
      - ios/Flutter/flutter_export_environment.sh

    cache:
      cache_paths:
        - ~/.pub-cache
        - ios/Pods
        - ios/.symlinks
